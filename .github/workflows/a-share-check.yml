name: 检测A股下跌家数并推送通知

on:
  schedule:
    - cron: "*/15 1-7 * * 1-5"  # 每15分钟检测一次（仅周一到周五，北京时间9点-15点）
  workflow_dispatch:              # 可手动触发

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: 获取下跌家数
        id: fetch
        run: |
          echo "正在获取东方财富A股市场数据..."
          data=$(curl -s "https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&fields=f104&secids=1.000001")
          
          # 提取下跌家数（f104字段）
          down=$(echo "$data" | grep -o '"f104":[0-9]*' | head -n1 | cut -d: -f2)
          
          if [ -z "$down" ]; then
            echo "❌ 获取数据失败，可能接口变更或网络问题。"
            down=0
          fi

          echo "当前下跌家数：$down"
          echo "down=$down" >> $GITHUB_OUTPUT

      - name: 判断并推送 Server酱 Turbo 通知
        if: ${{ steps.fetch.outputs.down > 3500 }}
        run: |
          echo "⚠️ 下跌家数超出阈值，正在推送通知..."
          curl -s -X POST "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}" \
            -d "title=A股预警：下跌家数超过3500家🚨" \
            -d "desp=当前下跌家数：${{ steps.fetch.outputs.down }}%0A数据来源：东方财富%0A触发时间：$(date '+%Y-%m-%d %H:%M:%S')"
          echo "✅ 已请求 Server酱 推送"

      - name: 打印结果日志
        if: always()
        run: |
          echo "------ 执行结果摘要 ------"
          echo "当前下跌家数：${{ steps.fetch.outputs.down }}"
          if [ ${{ steps.fetch.outputs.down }} -gt 3500 ]; then
            echo "结果：已触发推送 🚨"
          else
            echo "结果：未达到阈值（未推送） ✅"
          fi
