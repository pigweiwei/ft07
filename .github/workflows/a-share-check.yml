name: æ£€æµ‹Aè‚¡ä¸‹è·Œå®¶æ•°å¹¶æ¨é€é€šçŸ¥

on:
  schedule:
    - cron: "*/15 1-7 * * 1-5"  # æ¯15åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡ï¼ˆä»…å‘¨ä¸€åˆ°å‘¨äº”ï¼ŒåŒ—äº¬æ—¶é—´9ç‚¹-15ç‚¹ï¼‰
  workflow_dispatch:              # å¯æ‰‹åŠ¨è§¦å‘

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: è·å–ä¸‹è·Œå®¶æ•°
        id: fetch
        run: |
          echo "æ­£åœ¨è·å–ä¸œæ–¹è´¢å¯ŒAè‚¡å¸‚åœºæ•°æ®..."
          data=$(curl -s "https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&fields=f104&secids=1.000001")
          
          # æå–ä¸‹è·Œå®¶æ•°ï¼ˆf104å­—æ®µï¼‰
          down=$(echo "$data" | grep -o '"f104":[0-9]*' | head -n1 | cut -d: -f2)
          
          if [ -z "$down" ]; then
            echo "âŒ è·å–æ•°æ®å¤±è´¥ï¼Œå¯èƒ½æ¥å£å˜æ›´æˆ–ç½‘ç»œé—®é¢˜ã€‚"
            down=0
          fi

          echo "å½“å‰ä¸‹è·Œå®¶æ•°ï¼š$down"
          echo "down=$down" >> $GITHUB_OUTPUT

      - name: åˆ¤æ–­å¹¶æ¨é€ Serveré…± Turbo é€šçŸ¥
        if: ${{ steps.fetch.outputs.down > 3500 }}
        run: |
          echo "âš ï¸ ä¸‹è·Œå®¶æ•°è¶…å‡ºé˜ˆå€¼ï¼Œæ­£åœ¨æ¨é€é€šçŸ¥..."
          curl -s -X POST "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}" \
            -d "title=Aè‚¡é¢„è­¦ï¼šä¸‹è·Œå®¶æ•°è¶…è¿‡3500å®¶ğŸš¨" \
            -d "desp=å½“å‰ä¸‹è·Œå®¶æ•°ï¼š${{ steps.fetch.outputs.down }}%0Aæ•°æ®æ¥æºï¼šä¸œæ–¹è´¢å¯Œ%0Aè§¦å‘æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
          echo "âœ… å·²è¯·æ±‚ Serveré…± æ¨é€"

      - name: æ‰“å°ç»“æœæ—¥å¿—
        if: always()
        run: |
          echo "------ æ‰§è¡Œç»“æœæ‘˜è¦ ------"
          echo "å½“å‰ä¸‹è·Œå®¶æ•°ï¼š${{ steps.fetch.outputs.down }}"
          if [ ${{ steps.fetch.outputs.down }} -gt 3500 ]; then
            echo "ç»“æœï¼šå·²è§¦å‘æ¨é€ ğŸš¨"
          else
            echo "ç»“æœï¼šæœªè¾¾åˆ°é˜ˆå€¼ï¼ˆæœªæ¨é€ï¼‰ âœ…"
          fi
