name: 同花顺网页家数推送

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  ths_web_scrape:
    runs-on: ubuntu-latest
    steps:
      - name: 获取同花顺网页数据
        run: |
          echo "🌐 正在抓取同花顺市场总览网页..."

          # 设置User-Agent防止被拒
          html=$(curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" "https://q.10jqka.com.cn/")

          # 打印网页前500字符检查
          echo "${html:0:500}"

          # 提取上涨、下跌家数 (假设网页里有类似 '上涨家数 1234' 的文本)
          up_count=$(echo "$html" | grep -oP '上涨家数\s*\K[0-9]+')
          down_count=$(echo "$html" | grep -oP '下跌家数\s*\K[0-9]+')

          up_count=${up_count:-0}
          down_count=${down_count:-0}

          echo "📈 上涨家数: $up_count"
          echo "📉 下跌家数: $down_count"

          # 推送逻辑（手动或条件触发）
          force_push=false
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            force_push=true
          fi

          if $force_push || [ "$up_count" -gt 3000 ] || [ "$down_count" -gt 3000 ]; then
            title="📊 同花顺市场家数监控"
            desp="上涨家数：$up_count\n下跌家数：$down_count"

            echo "🚀 推送 Server酱..."
            curl -s "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}.send" \
              --data-urlencode "title=$title" \
              --data-urlencode "desp=$desp"
          else
            echo "⏸️ 当前不触发推送"
          fi
