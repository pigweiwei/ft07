name: æ£€æµ‹Aè‚¡æ¶¨è·Œå®¶æ•°å¹¶æ¨é€é€šçŸ¥

on:
  schedule:
    - cron: "*/15 * * * *"  # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è¿è¡Œ

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: è·å–æ¶¨è·Œå®¶æ•°ï¼ˆä¸œæ–¹è´¢å¯Œæ¥å£ï¼‰
        run: |
          echo "ğŸ“Š æ­£åœ¨è·å–ä¸œæ–¹è´¢å¯Œå¸‚åœºæ•°æ®..."

          # è·å–ä¸œæ–¹è´¢å¯ŒAè‚¡æ€»ä½“è¡Œæƒ…
          resp=$(curl -s "https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&invt=2&pi=1&pz=1&fid=f3&fs=m:1+t:2,m:0+t:6&fields=f104,f105" | iconv -f gbk -t utf-8)
          echo "åŸå§‹è¿”å›ï¼š$resp"

          # æå–ä¸Šæ¶¨å®¶æ•°å’Œä¸‹è·Œå®¶æ•°
          up_count=$(echo "$resp" | grep -o '"f104":[0-9]*' | head -n1 | awk -F: '{print $2}')
          down_count=$(echo "$resp" | grep -o '"f105":[0-9]*' | head -n1 | awk -F: '{print $2}')

          # é˜²æ­¢ä¸ºç©ºçš„æƒ…å†µ
          up_count=${up_count:-0}
          down_count=${down_count:-0}

          echo "ä¸Šæ¶¨å®¶æ•°ï¼š$up_count"
          echo "ä¸‹è·Œå®¶æ•°ï¼š$down_count"

          # å½“å‰æ—¶é—´ï¼ˆä¸œå…«åŒºï¼‰
          hour=$(date -u +"%H")
          minute=$(date -u +"%M")
          weekday=$(date -u +"%u")
          hour_cn=$(( (hour + 8) % 24 ))

          # åˆ¤æ–­æ˜¯å¦ä¸ºæ‰‹åŠ¨è¿è¡Œ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸŸ¢ æ‰‹åŠ¨è¿è¡Œï¼Œå¼ºåˆ¶æ¨é€ä¸€æ¬¡"
            force_push=true
          else
            force_push=false
          fi

          # åˆ¤æ–­æ˜¯å¦åœ¨äº¤æ˜“æ—¶é—´ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼Œ9:15~15:00ï¼‰
          if [ "$weekday" -lt 6 ] && [ "$hour_cn" -ge 9 ] && [ "$hour_cn" -lt 15 ]; then
            in_time=true
          else
            in_time=false
          fi

          # åˆ¤æ–­æ˜¯å¦è§¦å‘æ¨é€æ¡ä»¶
          if $force_push || ([ "$in_time" = true ] && { [ "$up_count" -gt 3000 ] || [ "$down_count" -gt 3000 ]; }); then
            if [ "$down_count" -gt 3000 ]; then
              title="ğŸ“‰ ä¸‹è·Œå®¶æ•°è¿‡å¤šæé†’"
              desp="ä¸‹è·Œå®¶æ•°ï¼š${down_count}\nä¸Šæ¶¨å®¶æ•°ï¼š${up_count}\nå¸‚åœºåå¼±ï¼Œæ³¨æ„é£é™©âš ï¸"
            elif [ "$up_count" -gt 3000 ]; then
              title="ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°è¿‡å¤šæé†’"
              desp="ä¸Šæ¶¨å®¶æ•°ï¼š${up_count}\nä¸‹è·Œå®¶æ•°ï¼š${down_count}\nå¸‚åœºæƒ…ç»ªåå¼ºğŸ’ª"
            else
              title="ğŸ§­ å½“å‰å¸‚åœºå®¶æ•°ï¼ˆæ‰‹åŠ¨æ¨é€ï¼‰"
              desp="ä¸Šæ¶¨å®¶æ•°ï¼š${up_count}\nä¸‹è·Œå®¶æ•°ï¼š${down_count}\næ‰‹åŠ¨è§¦å‘æµ‹è¯•æ¨é€âœ…"
            fi

            echo "ğŸš€ æ­£åœ¨æ¨é€ Serveré…± æ¶ˆæ¯..."
            curl -s "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}.send" \
              --data-urlencode "title=$title" \
              --data-urlencode "desp=$desp"
          else
            echo "â¸ï¸ å½“å‰ä¸åœ¨æ¨é€æ¡ä»¶å†…ï¼ˆ$hour_cn ç‚¹ï¼Œweekday=$weekdayï¼Œforce=$force_pushï¼‰"
          fi
