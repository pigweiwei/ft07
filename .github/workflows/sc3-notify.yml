name: æ£€æµ‹Aè‚¡æ¶¨è·Œå®¶æ•°å¹¶æ¨é€é€šçŸ¥

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 09:15â€“15:00 => UTC 01:15â€“07:00
    - cron: "*/15 1-7 * * 1-5"
  workflow_dispatch:

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: å®‰è£… jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: è·å–æ¶¨è·Œå®¶æ•°
        id: fetch
        run: |
          # åˆå§‹åŒ–å˜é‡
          up=""
          down=""
          data=""
          error_msg=""
          source="æœªçŸ¥"

          # å°è¯•æ–°æµªè´¢ç»æ¥å£ï¼ˆä¸»æ¥å£ï¼Œå…è´¹ç¨³å®šï¼‰
          echo "å°è¯•æ–°æµªè´¢ç»æ¥å£..."
          data=$(curl -s -m 10 --compressed -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" "http://market.finance.sina.com.cn/downxls.php?date=2025-10-21&downType=day")
          status_code=$(curl -s -o /dev/null -w "%{http_code}" --compressed -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" "http://market.finance.sina.com.cn/downxls.php?date=2025-10-21&downType=day")
          echo "æ–°æµªè´¢ç»æ¥å£çŠ¶æ€ç : $status_code"
          echo "æ–°æµªè´¢ç»æ¥å£å“åº”é¢„è§ˆ: $(echo "$data" | head -c 200)..."

          if [ "$status_code" -eq 200 ] && [ -n "$data" ]; then
            # æ–°æµªè¿”å› CSV-like å­—ç¬¦ä¸²ï¼Œæ¶¨è·Œå®¶æ•°åœ¨ç‰¹å®šä½ç½®ï¼ˆä¸Šæ¶¨å®¶æ•°åœ¨ç¬¬ 8 åˆ—ï¼Œä¸‹è·Œåœ¨ç¬¬ 9 åˆ—å·¦å³ï¼Œæ ¹æ®å®é™…è°ƒæ•´ï¼‰
            # ç¤ºä¾‹æ ¼å¼: "æ—¥æœŸ,æ¶¨å¹…,è·Œå¹…,æ¶¨åœ,è·Œåœ,å‡è·Œç»Ÿè®¡..."
            up=$(echo "$data" | awk -F',' '{print $8}' | tail -1 | tr -d '" ' | grep -o '[0-9]*')
            down=$(echo "$data" | awk -F',' '{print $9}' | tail -1 | tr -d '" ' | grep -o '[0-9]*')
            if [ -n "$up" ] && [ -n "$down" ]; then
              source="æ–°æµªè´¢ç»"
            fi
          fi

          # å¦‚æœæ–°æµªå¤±è´¥ï¼Œå°è¯•ä¸œæ–¹è´¢å¯Œå¤‡ç”¨æ¥å£
          if [ -z "$up" ] || [ -z "$down" ]; then
            echo "æ–°æµªå¤±è´¥ï¼Œå°è¯•ä¸œæ–¹è´¢å¯Œæ¥å£..."
            data=$(curl -s -m 10 --compressed -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" "https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=1.000001,0.399001,0.399006&fields=f62,f104,f105")
            status_code=$(curl -s -o /dev/null -w "%{http_code}" --compressed -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" "https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=1.000001,0.399001,0.399006&fields=f62,f104,f105")
            echo "ä¸œæ–¹è´¢å¯Œæ¥å£çŠ¶æ€ç : $status_code"
            echo "ä¸œæ–¹è´¢å¯Œæ¥å£å“åº”é¢„è§ˆ: $(echo "$data" | head -c 200)..."

            if [ "$status_code" -eq 200 ] && [ -n "$data" ] && echo "$data" | jq . >/dev/null 2>&1; then
              up=$(echo "$data" | jq -r '.data.diff[0].f104 // 0')  # ä¸Šæ¶¨å®¶æ•°
              down=$(echo "$data" | jq -r '.data.diff[0].f105 // 0') # ä¸‹è·Œå®¶æ•°
              if [ -n "$up" ] && [ -n "$down" ]; then
                source="ä¸œæ–¹è´¢å¯Œ"
              fi
            fi
          fi

          # æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–æ•°æ®
          if [ -z "$up" ] || [ -z "$down" ]; then
            error_msg="æ‰€æœ‰æ¥å£å¤±è´¥ã€‚æ–°æµªçŠ¶æ€ç : $status_codeï¼Œå“åº”é¢„è§ˆ: $(echo "$data" | head -c 100)ã€‚å»ºè®®æ£€æŸ¥æ—¥æœŸæˆ–æ¥å£å˜æ›´ã€‚"
            echo "é”™è¯¯ï¼š$error_msg"
            echo "error_msg=$error_msg" >> $GITHUB_ENV
            echo "up=0" >> $GITHUB_ENV
            echo "down=0" >> $GITHUB_ENV
            # ä¸é€€å‡ºï¼Œç»§ç»­æ¨é€é”™è¯¯é€šçŸ¥
          else
            echo "æˆåŠŸè·å–ï¼ä¸Šæ¶¨å®¶æ•°: $up, ä¸‹è·Œå®¶æ•°: $down (æ¥æº: $source)"
            echo "up=$up" >> $GITHUB_ENV
            echo "down=$down" >> $GITHUB_ENV
            echo "source=$source" >> $GITHUB_ENV
          fi

      - name: åˆ¤æ–­å¹¶æ¨é€
        run: |
          up=${{ env.up }}
          down=${{ env.down }}
          source="${{ env.source }}"
          error_msg="${{ env.error_msg }}"

          title=""
          desp="å½“å‰ä¸Šæ¶¨å®¶æ•°ï¼š${up}\nå½“å‰ä¸‹è·Œå®¶æ•°ï¼š${down}\n\nğŸ“Š æ•°æ®æ¥æºï¼š${source:-æœªçŸ¥}"
          if [ -n "$error_msg" ]; then
            title="âš ï¸ Aè‚¡æ•°æ®è·å–å¤±è´¥ï¼"
            desp="$desp\n\nâš ï¸ é”™è¯¯ä¿¡æ¯ï¼š$error_msg"
          else
            if [ "$up" -gt 3000 ]; then
              title="ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°è¶…è¿‡3000å®¶ï¼"
            elif [ "$down" -gt 3000 ]; then
              title="ğŸ“‰ ä¸‹è·Œå®¶æ•°è¶…è¿‡3000å®¶ï¼"
            else
              echo "æ¶¨è·Œå®¶æ•°å‡æœªè¶…è¿‡3000ï¼Œæ— éœ€æ¨é€ã€‚"
              exit 0
            fi
          fi

          echo "å‘é€æ¨é€ï¼š$title"
          curl -G "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}.send" \
            --data-urlencode "title=$title" \
            --data-urlencode "desp=$desp"
