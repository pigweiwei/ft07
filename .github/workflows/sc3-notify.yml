name: åŒèŠ±é¡ºå¸‚åœºå®¶æ•°è°ƒè¯•æ¨é€

on:
  schedule:
    - cron: "*/15 9-15 * * 1-5"  # å‘¨ä¸€åˆ°å‘¨äº” 9:00-15:59 æ¯15åˆ†é’Ÿæ‰§è¡Œ
  workflow_dispatch:

jobs:
  debug_push:
    runs-on: ubuntu-latest
    env:
      SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}
    steps:
      - name: å®‰è£… Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install requests

      - name: æŠ“å–åŒèŠ±é¡ºæ•°æ®å¹¶è°ƒè¯•æ¨é€
        run: |
          python - <<'EOF'
          import requests
          import os
          import json

          # TODO: æ›¿æ¢ä¸ºä½ æŠ“åˆ°çš„åŒèŠ±é¡º Ajax JSON URL
          AJAX_URL = "https://push2.eastmoney.com/api/qt/clist/get?cb=jQuery123456&pn=1&pz=50&po=1&np=1&ut=xxx&fields=f14,f3,f2,f12,f13"

          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
          }

          try:
              resp = requests.get(AJAX_URL, headers=headers)
              resp.raise_for_status()
              print("âœ… è¯·æ±‚æˆåŠŸï¼ŒçŠ¶æ€ç :", resp.status_code)

              # æ‰“å°åŸå§‹è¿”å›å†…å®¹ï¼Œæ–¹ä¾¿è°ƒè¯•
              print("åŸå§‹è¿”å›å†…å®¹å‰200å­—ç¬¦:", resp.text[:200])

              text = resp.text
              if text.startswith("jQuery"):
                  start = text.find('(') + 1
                  end = text.rfind(')')
                  json_str = text[start:end]
              else:
                  json_str = text

              data = json.loads(json_str)
              print("è§£æåçš„ JSON å‰200å­—ç¬¦:", json.dumps(data)[:200])

              # âš ï¸ æ ¹æ®è¿”å›çš„ JSON å®é™…å­—æ®µä¿®æ”¹
              up_count = int(data.get("data", {}).get("upcount", 0))
              down_count = int(data.get("data", {}).get("downcount", 0))

              print(f"ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°: {up_count}")
              print(f"ğŸ“‰ ä¸‹è·Œå®¶æ•°: {down_count}")

              event_name = os.environ.get('GITHUB_EVENT_NAME', '')
              force_push = event_name == 'workflow_dispatch'

              print(f"event_name={event_name}, force_push={force_push}")

              # å¼ºåˆ¶æ¨é€æˆ–è¶…è¿‡é˜ˆå€¼æ—¶æ¨é€
              if force_push or up_count > 3000 or down_count > 3000:
                  title = "ğŸ§­ åŒèŠ±é¡ºå¸‚åœºå®¶æ•°ç›‘æ§"
                  if down_count > 3000:
                      title = "ğŸ“‰ ä¸‹è·Œå®¶æ•°è¿‡å¤š"
                  elif up_count > 3000:
                      title = "ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°è¿‡å¤š"
                  desp = f"ä¸Šæ¶¨å®¶æ•°ï¼š{up_count}\nä¸‹è·Œå®¶æ•°ï¼š{down_count}"

                  key = os.environ.get('SERVERCHAN_KEY', '')
                  if key:
                      push_url = f"https://12404.push.ft07.com/send/{key}.send"
                      r = requests.get(push_url, params={"title": title, "desp": desp})
                      print("ğŸš€ æ¨é€å®Œæˆï¼ŒçŠ¶æ€ç :", r.status_code)
                  else:
                      print("âš ï¸ SERVERCHAN_KEY æœªè®¾ç½®")
              else:
                  print("â¸ï¸ å½“å‰ä¸è§¦å‘æ¨é€ï¼Œå› ä¸ºæœªè¶…è¿‡é˜ˆå€¼ä¸”éæ‰‹åŠ¨è§¦å‘")

          except Exception as e:
              print(f"âŒ æŠ“å–æˆ–æ¨é€å¤±è´¥: {e}")
          EOF
