name: æ£€æµ‹Aè‚¡æ¶¨è·Œå®¶æ•°å¹¶æ¨é€é€šçŸ¥

on:
  schedule:
    - cron: "*/15 1-7 * * 1-5" # åŒ—äº¬æ—¶é—´09:15â€“15:00
  workflow_dispatch:

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: è·å–æ¶¨è·Œå®¶æ•°ï¼ˆæ‰“å°åŸå§‹è¿”å›ï¼‰
        id: fetch
        run: |
          echo "æ­£åœ¨è·å–ç½‘æ˜“è´¢ç»å¸‚åœºæ•°æ®..."
          data=$(curl -s "https://api.money.126.net/data/feed/0000001,1399001,money.api?callback=a")

          echo "------ åŸå§‹è¿”å›å‰300å­—ç¬¦ ------"
          echo "$data" | head -c 300
          echo ""
          echo "--------------------------------"

          # å°è¯•æå–æ•°å­—å­—æ®µï¼ˆå…¼å®¹å¤šç§å†™æ³•ï¼‰
          up=$(echo "$data" | grep -Eo '"up":[0-9]+' | head -1 | grep -Eo '[0-9]+')
          down=$(echo "$data" | grep -Eo '"down":[0-9]+' | head -1 | grep -Eo '[0-9]+')

          # è‹¥ä¸ºç©ºï¼Œç½®ä¸º0é˜²æ­¢æŠ¥é”™
          up=${up:-0}
          down=${down:-0}

          echo "ä¸Šæ¶¨å®¶æ•°: $up"
          echo "ä¸‹è·Œå®¶æ•°: $down"

          echo "up=$up" >> $GITHUB_ENV
          echo "down=$down" >> $GITHUB_ENV

      - name: åˆ¤æ–­å¹¶æ¨é€
        run: |
          up=${{ env.up }}
          down=${{ env.down }}

          title=""
          desp="å½“å‰ä¸Šæ¶¨å®¶æ•°ï¼š${up}\nå½“å‰ä¸‹è·Œå®¶æ•°ï¼š${down}\n\nğŸ“Š æ•°æ®æ¥æºï¼šç½‘æ˜“è´¢ç»"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            title="ğŸ§ª æ‰‹åŠ¨æµ‹è¯•æ¨é€"
            echo "æ£€æµ‹åˆ°æ‰‹åŠ¨è¿è¡Œï¼Œå¼ºåˆ¶æ¨é€å½“å‰æ•°æ®ã€‚"
          else
            if [ "$up" -gt 3000 ]; then
              title="ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°è¶…è¿‡3000å®¶ï¼"
            elif [ "$down" -gt 3000 ]; then
              title="ğŸ“‰ ä¸‹è·Œå®¶æ•°è¶…è¿‡3000å®¶ï¼"
            else
              echo "æ¶¨è·Œå®¶æ•°å‡æœªè¶…è¿‡3000ï¼Œæ— éœ€æ¨é€ã€‚"
              exit 0
            fi
          fi

          echo "å‘é€æ¨é€ï¼š$title"
          curl -G "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}.send" \
            --data-urlencode "title=$title" \
            --data-urlencode "desp=$desp"
