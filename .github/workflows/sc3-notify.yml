name: æ£€æµ‹Aè‚¡æ¶¨è·Œå®¶æ•°å¹¶æ¨é€é€šçŸ¥

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 09:15â€“15:00 => UTC 01:15â€“07:00ï¼Œæ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    - cron: "*/15 1-7 * * 1-5"
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è¿è¡Œ

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€æµ‹Aè‚¡æ¶¨è·Œå®¶æ•°å¹¶æ¨é€
        env:
          SCKEY: ${{ secrets.SERVERCHAN_KEY }}  # Serveré…±Â³å¯†é’¥
        run: |
          python3 - <<'EOF'
          import requests, datetime, sys

          # ========== åŸºç¡€é…ç½® ==========
          SERVER_KEY = "${{ secrets.SERVERCHAN_KEY }}"
          PUSH_URL = f"https://sctapi.ftqq.com/{SERVER_KEY}.send"
          EASTMONEY_URL = "https://push2.eastmoney.com/api/qt/ulist.np/get"
          CALENDAR_URL = "https://api.toolhub.cn/api/holiday/info"  # å…è´¹èŠ‚å‡æ—¥æ¥å£

          # ========== å·¥å…·å‡½æ•° ==========
          def is_trading_day():
              """æ£€æµ‹ä»Šå¤©æ˜¯å¦ä¸ºäº¤æ˜“æ—¥"""
              today = datetime.date.today().strftime("%Y-%m-%d")
              try:
                  r = requests.get(CALENDAR_URL, params={"date": today}, timeout=5)
                  data = r.json()
                  if data.get("code") == 200:
                      if data["data"]["workday"]:
                          return True
                      else:
                          print("ğŸ“… ä»Šå¤©æ˜¯å‡æœŸæˆ–å‘¨æœ«ï¼Œè·³è¿‡æ¨é€ã€‚")
                          return False
              except Exception as e:
                  print(f"âš ï¸ èŠ‚å‡æ—¥æ¥å£å¼‚å¸¸ï¼š{e}ï¼Œé»˜è®¤è§†ä¸ºäº¤æ˜“æ—¥ã€‚")
                  return True
              return True

          def push_serverchan(title, desp):
              """æ¨é€åˆ° Serveré…±Â³"""
              try:
                  r = requests.post(PUSH_URL, data={"title": title, "desp": desp})
                  if r.status_code == 200:
                      print("âœ… æ¨é€æˆåŠŸ")
                  else:
                      print(f"âŒ æ¨é€å¤±è´¥ï¼š{r.text}")
              except Exception as e:
                  print(f"âŒ æ¨é€å¼‚å¸¸ï¼š{e}")

          # ========== ä¸»é€»è¾‘ ==========
          now = datetime.datetime.now()
          hour = now.hour

          # éäº¤æ˜“æ—¶é—´è‡ªåŠ¨é€€å‡ºï¼ˆæ‰‹åŠ¨è¿è¡Œé™¤å¤–ï¼‰
          manual = "workflow_dispatch" in sys.argv
          if not manual and (hour < 9 or hour >= 15):
              print("â¸ å½“å‰éäº¤æ˜“æ—¶æ®µï¼Œä¸æ¨é€ã€‚")
              sys.exit(0)

          if not manual and not is_trading_day():
              sys.exit(0)

          print("ğŸ“¡ è·å–ä¸œæ–¹è´¢å¯Œæ•°æ®ä¸­...")

          params = {
              "fltt": "2",
              "secids": "1.000001,0.399001",
              "fields": "f104,f105"
          }

          try:
              r = requests.get(EASTMONEY_URL, params=params, timeout=10)
              data = r.json()
              diff = data["data"]["diff"]
          except Exception as e:
              print(f"âŒ è·å–ä¸œæ–¹è´¢å¯Œæ•°æ®å¤±è´¥ï¼š{e}")
              sys.exit(1)

          try:
              up_total = diff[0]["f104"]
              down_total = diff[0]["f105"]
              total = up_total + down_total
              up_ratio = round(up_total / total * 100, 1)
              down_ratio = round(down_total / total * 100, 1)
          except Exception as e:
              print(f"âŒ æ•°æ®è§£æé”™è¯¯ï¼š{e}")
              sys.exit(1)

          # ========== æ„é€ æ¨é€å†…å®¹ ==========
          date_str = now.strftime("%Y-%m-%d %H:%M")
          title = f"Aè‚¡æ¶¨è·Œå®¶æ•°ï¼ˆ{date_str}ï¼‰"
          desp = (
              f"ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°ï¼š{up_total}ï¼ˆ{up_ratio}%ï¼‰\n"
              f"ğŸ“‰ ä¸‹è·Œå®¶æ•°ï¼š{down_total}ï¼ˆ{down_ratio}%ï¼‰\n"
              f"ğŸ“Š æ€»å®¶æ•°ï¼š{total}"
          )

          print("ğŸ“¬ æ¨é€å†…å®¹å¦‚ä¸‹ï¼š\n" + desp)
          push_serverchan(title, desp)
          EOF
