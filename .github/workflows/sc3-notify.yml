name: æ£€æµ‹Aè‚¡æ¶¨è·Œå®¶æ•°å¹¶æ¨é€é€šçŸ¥

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 09:15â€“15:00 => UTC 01:15â€“07:00ï¼Œæ¯5åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
    - cron: "*/5 1-7 * * 1-5"
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è¿è¡Œ

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: å®‰è£…ä¾èµ–
        run: sudo apt-get install -y jq

      - name: æ£€æµ‹Aè‚¡æ¶¨è·Œå®¶æ•°
        id: fetch
        run: |
          API_URL="https://push2.eastmoney.com/api/qt/ulist.np/get?fields=f104,f105,f106,f107,f113&fltt=2&secids=1.000001"
          DATA=$(curl -s "$API_URL" | jq '.data.diff[0]')
          UP=$(echo "$DATA" | jq -r '.f104')
          DOWN=$(echo "$DATA" | jq -r '.f105')
          TOTAL=$((UP + DOWN))
          API_DATE=$(curl -s "https://push2.eastmoney.com/api/qt/stock/get?secid=1.000001" | jq -r '.data.f57')
          NOW_DATE=$(date +%Y%m%d)

          echo "UP=$UP" >> $GITHUB_ENV
          echo "DOWN=$DOWN" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          echo "API_DATE=$API_DATE" >> $GITHUB_ENV
          echo "NOW_DATE=$NOW_DATE" >> $GITHUB_ENV

      - name: æ£€æŸ¥ä¸Šæ¬¡æ•°æ®å¹¶å†³å®šæ˜¯å¦æ¨é€
        id: check
        run: |
          STATE_FILE="/tmp/last_push.json"
          IS_MANUAL="${{ github.event_name == 'workflow_dispatch' }}"
          
          echo "å½“å‰è¿è¡Œæ¨¡å¼: $IS_MANUAL"

          # å¦‚æœAPIæ—¥æœŸå’Œæœ¬åœ°æ—¥æœŸä¸åŒï¼ˆä¼‘å¸‚ï¼‰ï¼Œåˆ™é€€å‡ºï¼ˆé™¤éæ‰‹åŠ¨è¿è¡Œï¼‰
          if [ "$API_DATE" != "$NOW_DATE" ] && [ "$IS_MANUAL" != "true" ]; then
            echo "âšª éäº¤æ˜“æ—¥ï¼Œè·³è¿‡æ¨é€"
            echo "should_push=false" >> $GITHUB_ENV
            exit 0
          fi

          # å¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼Œé‡ç½®çŠ¶æ€æ–‡ä»¶
          if [ -f "$STATE_FILE" ]; then
            LAST_DATE=$(jq -r '.date' "$STATE_FILE")
            if [ "$LAST_DATE" != "$NOW_DATE" ]; then
              echo "{}" > "$STATE_FILE"
            fi
          fi

          # å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œåˆ™ç›´æ¥æ¨é€
          if [ ! -f "$STATE_FILE" ] || [ "$(jq -r '.up' "$STATE_FILE" 2>/dev/null)" == "null" ]; then
            echo "{\"up\":$UP,\"down\":$DOWN,\"date\":\"$NOW_DATE\"}" > "$STATE_FILE"
            echo "should_push=true" >> $GITHUB_ENV
            exit 0
          fi

          LAST_UP=$(jq -r '.up' "$STATE_FILE")
          LAST_DOWN=$(jq -r '.down' "$STATE_FILE")

          DIFF_UP=$((UP - LAST_UP))
          DIFF_DOWN=$((DOWN - LAST_DOWN))
          ABS_UP=${DIFF_UP#-}
          ABS_DOWN=${DIFF_DOWN#-}

          echo "ä¸Šæ¬¡ä¸Šæ¶¨å®¶æ•°ï¼š$LAST_UP"
          echo "ä¸Šæ¬¡ä¸‹è·Œå®¶æ•°ï¼š$LAST_DOWN"
          echo "å˜åŒ–ï¼šä¸Šæ¶¨=$DIFF_UP ä¸‹è·Œ=$DIFF_DOWN"

          # å¦‚æœä¸¤ä¸ªå˜åŒ–éƒ½ â‰¤ 500 ä¸”ä¸æ˜¯æ‰‹åŠ¨è¿è¡Œï¼Œåˆ™ä¸æ¨é€
          if [ "$ABS_UP" -le 500 ] && [ "$ABS_DOWN" -le 500 ] && [ "$IS_MANUAL" != "true" ]; then
            echo "å˜åŒ–ä¸è¶³500ï¼Œè·³è¿‡æ¨é€"
            echo "should_push=false" >> $GITHUB_ENV
            exit 0
          fi

          # è®°å½•æ–°çŠ¶æ€
          echo "{\"up\":$UP,\"down\":$DOWN,\"date\":\"$NOW_DATE\"}" > "$STATE_FILE"
          echo "should_push=true" >> $GITHUB_ENV

      - name: æ¨é€åˆ°Serveré…±
        if: env.should_push == 'true'
        run: |
          KEY="${{ secrets.SERVER_KEY }}"
          TITLE="Aè‚¡æ¶¨è·Œå®¶æ•°"
          PERCENT_UP=$(awk "BEGIN {printf \"%.2f\", $UP/$TOTAL*100}")
          PERCENT_DOWN=$(awk "BEGIN {printf \"%.2f\", $DOWN/$TOTAL*100}")
          DESP="ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°ï¼š${UP} (${PERCENT_UP}%)\nğŸ“‰ ä¸‹è·Œå®¶æ•°ï¼š${DOWN} (${PERCENT_DOWN}%)\nğŸ“Š æ€»å®¶æ•°ï¼š${TOTAL}\nğŸ“… æ—¥æœŸï¼š${NOW_DATE}"

          curl -s "https://sc3.ft07.com/send/$KEY.send?title=${TITLE}&desp=${DESP}"
