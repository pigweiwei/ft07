name: 检测A股涨跌家数并推送通知

on:
  schedule:
    # 北京时间 09:15–15:00 => UTC 01:15–07:00
    - cron: "*/15 1-7 * * 1-5"
  workflow_dispatch:

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: 安装 jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 获取涨跌家数
        id: fetch
        run: |
          # 初始化变量
          up=""
          down=""
          data=""
          error_msg=""

          # 尝试同花顺接口
          echo "尝试同花顺接口..."
          data=$(curl -s -m 10 -H "User-Agent: Mozilla/5.0" "http://q.10jqka.com.cn/api.php?t=index&f=updown")
          status_code=$(curl -s -o /dev/null -w "%{http_code}" -H "User-Agent: Mozilla/5.0" "http://q.10jqka.com.cn/api.php?t=index&f=updown")
          echo "同花顺接口状态码: $status_code"
          echo "同花顺接口响应: $data"

          if [ "$status_code" -eq 200 ] && [ -n "$data" ] && echo "$data" | jq . >/dev/null 2>&1; then
            up=$(echo "$data" | jq -r '.data.up // 0')
            down=$(echo "$data" | jq -r '.data.down // 0')
          else
            error_msg="同花顺接口失败 (状态码: $status_code, 响应: $data)，尝试备用接口..."
            echo "$error_msg"
          fi

          # 如果同花顺失败，尝试腾讯财经接口
          if [ -z "$up" ] || [ -z "$down" ]; then
            echo "尝试腾讯财经接口..."
            data=$(curl -s -m 10 -H "User-Agent: Mozilla/5.0" "https://qt.gtimg.cn/q=marketStat")
            status_code=$(curl -s -o /dev/null -w "%{http_code}" -H "User-Agent: Mozilla/5.0" "https://qt.gtimg.cn/q=marketStat")
            echo "腾讯财经接口状态码: $status_code"
            echo "腾讯财经接口响应: $data"

            # 腾讯财经返回格式示例: v_marketStat="...;up_count,down_count,...;"
            if [ "$status_code" -eq 200 ] && [ -n "$data" ]; then
              up=$(echo "$data" | grep -o 'v_marketStat="[^;]*;[0-9]*' | cut -d';' -f2)
              down=$(echo "$data" | grep -o 'v_marketStat="[^;]*;[^;]*;[0-9]*' | cut -d';' -f3)
            else
              error_msg="$error_msg\n腾讯财经接口失败 (状态码: $status_code, 响应: $data)"
              echo "$error_msg"
            fi
          fi

          # 检查是否成功获取数据
          if [ -z "$up" ] || [ -z "$down" ]; then
            echo "错误：所有接口均无法提取涨跌家数"
            echo "error_msg=$error_msg" >> $GITHUB_ENV
            exit 1
          fi

          echo "上涨家数: $up"
          echo "下跌家数: $down"
          echo "up=$up" >> $GITHUB_ENV
          echo "down=$down" >> $GITHUB_ENV

      - name: 判断并推送
        if: env.up != '' && env.down != ''
        run: |
          up=${{ env.up }}
          down=${{ env.down }}
          error_msg="${{ env.error_msg }}"

          title=""
          desp="当前上涨家数：${up}\n当前下跌家数：${down}\n\n📊 数据来源：同花顺或腾讯财经"
          if [ -n "$error_msg" ]; then
            desp="$desp\n\n⚠️ 错误信息：$error_msg"
          fi

          if [ "$up" -gt 3000 ]; then
            title="📈 上涨家数超过3000家！"
          elif [ "$down" -gt 3000 ]; then
            title="📉 下跌家数超过3000家！"
          else
            echo "涨跌家数均未超过3000，无需推送。"
            exit 0
          fi

          echo "发送推送：$title"
          curl -G "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}.send" \
            --data-urlencode "title=$title" \
            --data-urlencode "desp=$desp"
