name: æ£€æµ‹Aè‚¡æ¶¨è·Œå®¶æ•°å¹¶æ¨é€é€šçŸ¥

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 09:15â€“15:00 => UTC 01:15â€“07:00
    - cron: "*/15 1-7 * * 1-5"
  workflow_dispatch:

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: å®‰è£… jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: è·å–æ¶¨è·Œå®¶æ•°
        id: fetch
        run: |
          # åˆå§‹åŒ–å˜é‡
          up=""
          down=""
          data=""
          error_msg=""

          # å°è¯•åŒèŠ±é¡ºæ¥å£
          echo "å°è¯•åŒèŠ±é¡ºæ¥å£..."
          data=$(curl -s -m 10 -H "User-Agent: Mozilla/5.0" "http://q.10jqka.com.cn/api.php?t=index&f=updown")
          status_code=$(curl -s -o /dev/null -w "%{http_code}" -H "User-Agent: Mozilla/5.0" "http://q.10jqka.com.cn/api.php?t=index&f=updown")
          echo "åŒèŠ±é¡ºæ¥å£çŠ¶æ€ç : $status_code"
          echo "åŒèŠ±é¡ºæ¥å£å“åº”: $data"

          if [ "$status_code" -eq 200 ] && [ -n "$data" ] && echo "$data" | jq . >/dev/null 2>&1; then
            up=$(echo "$data" | jq -r '.data.up // 0')
            down=$(echo "$data" | jq -r '.data.down // 0')
          else
            error_msg="åŒèŠ±é¡ºæ¥å£å¤±è´¥ (çŠ¶æ€ç : $status_code, å“åº”: $data)ï¼Œå°è¯•å¤‡ç”¨æ¥å£..."
            echo "$error_msg"
          fi

          # å¦‚æœåŒèŠ±é¡ºå¤±è´¥ï¼Œå°è¯•è…¾è®¯è´¢ç»æ¥å£
          if [ -z "$up" ] || [ -z "$down" ]; then
            echo "å°è¯•è…¾è®¯è´¢ç»æ¥å£..."
            data=$(curl -s -m 10 -H "User-Agent: Mozilla/5.0" "https://qt.gtimg.cn/q=marketStat")
            status_code=$(curl -s -o /dev/null -w "%{http_code}" -H "User-Agent: Mozilla/5.0" "https://qt.gtimg.cn/q=marketStat")
            echo "è…¾è®¯è´¢ç»æ¥å£çŠ¶æ€ç : $status_code"
            echo "è…¾è®¯è´¢ç»æ¥å£å“åº”: $data"

            # è…¾è®¯è´¢ç»è¿”å›æ ¼å¼ç¤ºä¾‹: v_marketStat="...;up_count,down_count,...;"
            if [ "$status_code" -eq 200 ] && [ -n "$data" ]; then
              up=$(echo "$data" | grep -o 'v_marketStat="[^;]*;[0-9]*' | cut -d';' -f2)
              down=$(echo "$data" | grep -o 'v_marketStat="[^;]*;[^;]*;[0-9]*' | cut -d';' -f3)
            else
              error_msg="$error_msg\nè…¾è®¯è´¢ç»æ¥å£å¤±è´¥ (çŠ¶æ€ç : $status_code, å“åº”: $data)"
              echo "$error_msg"
            fi
          fi

          # æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–æ•°æ®
          if [ -z "$up" ] || [ -z "$down" ]; then
            echo "é”™è¯¯ï¼šæ‰€æœ‰æ¥å£å‡æ— æ³•æå–æ¶¨è·Œå®¶æ•°"
            echo "error_msg=$error_msg" >> $GITHUB_ENV
            exit 1
          fi

          echo "ä¸Šæ¶¨å®¶æ•°: $up"
          echo "ä¸‹è·Œå®¶æ•°: $down"
          echo "up=$up" >> $GITHUB_ENV
          echo "down=$down" >> $GITHUB_ENV

      - name: åˆ¤æ–­å¹¶æ¨é€
        if: env.up != '' && env.down != ''
        run: |
          up=${{ env.up }}
          down=${{ env.down }}
          error_msg="${{ env.error_msg }}"

          title=""
          desp="å½“å‰ä¸Šæ¶¨å®¶æ•°ï¼š${up}\nå½“å‰ä¸‹è·Œå®¶æ•°ï¼š${down}\n\nğŸ“Š æ•°æ®æ¥æºï¼šåŒèŠ±é¡ºæˆ–è…¾è®¯è´¢ç»"
          if [ -n "$error_msg" ]; then
            desp="$desp\n\nâš ï¸ é”™è¯¯ä¿¡æ¯ï¼š$error_msg"
          fi

          if [ "$up" -gt 3000 ]; then
            title="ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°è¶…è¿‡3000å®¶ï¼"
          elif [ "$down" -gt 3000 ]; then
            title="ğŸ“‰ ä¸‹è·Œå®¶æ•°è¶…è¿‡3000å®¶ï¼"
          else
            echo "æ¶¨è·Œå®¶æ•°å‡æœªè¶…è¿‡3000ï¼Œæ— éœ€æ¨é€ã€‚"
            exit 0
          fi

          echo "å‘é€æ¨é€ï¼š$title"
          curl -G "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}.send" \
            --data-urlencode "title=$title" \
            --data-urlencode "desp=$desp"
