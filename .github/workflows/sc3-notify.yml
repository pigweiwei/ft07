name: 获取A股涨跌家数并推送通知

on:
  schedule:
    - cron: "*/15 * * * *"  # 每15分钟执行一次
  workflow_dispatch:        # 支持手动触发

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: 获取涨跌家数(新浪财经接口)
        run: |
          echo "正在获取A股市场数据（新浪财经接口）..."

          # 使用新浪接口，GitHub国外服务器能访问
          data=$(curl -s "https://hq.sinajs.cn/list=sh000001,sz399001" | iconv -f gbk -t utf-8)

          echo "原始返回：$data"

          # 如果返回为空，推送一条测试消息
          if [[ -z "$data" ]]; then
            echo "❌ 未获取到数据，强制推送测试消息"
            title="⚠️ 测试推送（未获取到数据）"
            desp="可能被拦截或网络错误"
          else
            # 提取示例数值（注意：新浪接口不提供家数，这里只是演示）
            sh_val=$(echo "$data" | grep -oE '[0-9]+\.[0-9]+' | head -n 1)
            sz_val=$(echo "$data" | grep -oE '[0-9]+\.[0-9]+' | head -n 2 | tail -n 1)

            title="📈 A股市场情绪监控"
            desp="上证指数: ${sh_val}\n深证指数: ${sz_val}\n\n（本次为测试推送，接口运行正常）"
          fi

          echo "准备推送..."
          # ⚠️ 把 XXXXXX 改成你自己的 Server酱 Key
          curl -s "https://sc3.ft07.com/send/XXXXXX.send?title=${title}&desp=${desp}"
