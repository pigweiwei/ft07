name: 检测A股涨跌家数并推送通知

on:
  schedule:
    # 北京时间 09:15–15:00 => UTC 01:15–07:00
    - cron: "*/15 1-7 * * 1-5"
  workflow_dispatch:

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: 安装 jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 获取涨跌家数
        id: fetch
        run: |
          # 初始化变量
          up=""
          down=""
          data=""
          error_msg=""
          source="未知"

          # 尝试新浪财经接口（主接口，免费稳定）
          echo "尝试新浪财经接口..."
          data=$(curl -s -m 10 --compressed -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" "http://market.finance.sina.com.cn/downxls.php?date=2025-10-21&downType=day")
          status_code=$(curl -s -o /dev/null -w "%{http_code}" --compressed -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" "http://market.finance.sina.com.cn/downxls.php?date=2025-10-21&downType=day")
          echo "新浪财经接口状态码: $status_code"
          echo "新浪财经接口响应预览: $(echo "$data" | head -c 200)..."

          if [ "$status_code" -eq 200 ] && [ -n "$data" ]; then
            # 新浪返回 CSV-like 字符串，涨跌家数在特定位置（上涨家数在第 8 列，下跌在第 9 列左右，根据实际调整）
            # 示例格式: "日期,涨幅,跌幅,涨停,跌停,升跌统计..."
            up=$(echo "$data" | awk -F',' '{print $8}' | tail -1 | tr -d '" ' | grep -o '[0-9]*')
            down=$(echo "$data" | awk -F',' '{print $9}' | tail -1 | tr -d '" ' | grep -o '[0-9]*')
            if [ -n "$up" ] && [ -n "$down" ]; then
              source="新浪财经"
            fi
          fi

          # 如果新浪失败，尝试东方财富备用接口
          if [ -z "$up" ] || [ -z "$down" ]; then
            echo "新浪失败，尝试东方财富接口..."
            data=$(curl -s -m 10 --compressed -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" "https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=1.000001,0.399001,0.399006&fields=f62,f104,f105")
            status_code=$(curl -s -o /dev/null -w "%{http_code}" --compressed -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" "https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=1.000001,0.399001,0.399006&fields=f62,f104,f105")
            echo "东方财富接口状态码: $status_code"
            echo "东方财富接口响应预览: $(echo "$data" | head -c 200)..."

            if [ "$status_code" -eq 200 ] && [ -n "$data" ] && echo "$data" | jq . >/dev/null 2>&1; then
              up=$(echo "$data" | jq -r '.data.diff[0].f104 // 0')  # 上涨家数
              down=$(echo "$data" | jq -r '.data.diff[0].f105 // 0') # 下跌家数
              if [ -n "$up" ] && [ -n "$down" ]; then
                source="东方财富"
              fi
            fi
          fi

          # 检查是否成功获取数据
          if [ -z "$up" ] || [ -z "$down" ]; then
            error_msg="所有接口失败。新浪状态码: $status_code，响应预览: $(echo "$data" | head -c 100)。建议检查日期或接口变更。"
            echo "错误：$error_msg"
            echo "error_msg=$error_msg" >> $GITHUB_ENV
            echo "up=0" >> $GITHUB_ENV
            echo "down=0" >> $GITHUB_ENV
            # 不退出，继续推送错误通知
          else
            echo "成功获取！上涨家数: $up, 下跌家数: $down (来源: $source)"
            echo "up=$up" >> $GITHUB_ENV
            echo "down=$down" >> $GITHUB_ENV
            echo "source=$source" >> $GITHUB_ENV
          fi

      - name: 判断并推送
        run: |
          up=${{ env.up }}
          down=${{ env.down }}
          source="${{ env.source }}"
          error_msg="${{ env.error_msg }}"

          title=""
          desp="当前上涨家数：${up}\n当前下跌家数：${down}\n\n📊 数据来源：${source:-未知}"
          if [ -n "$error_msg" ]; then
            title="⚠️ A股数据获取失败！"
            desp="$desp\n\n⚠️ 错误信息：$error_msg"
          else
            if [ "$up" -gt 3000 ]; then
              title="📈 上涨家数超过3000家！"
            elif [ "$down" -gt 3000 ]; then
              title="📉 下跌家数超过3000家！"
            else
              echo "涨跌家数均未超过3000，无需推送。"
              exit 0
            fi
          fi

          echo "发送推送：$title"
          curl -G "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}.send" \
            --data-urlencode "title=$title" \
            --data-urlencode "desp=$desp"
