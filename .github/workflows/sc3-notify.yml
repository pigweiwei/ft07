name: 检测A股涨跌家数并推送通知

on:
  schedule:
    - cron: "*/15 1-7 * * 1-5" # 北京时间09:15–15:00
  workflow_dispatch:

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: 获取涨跌家数（打印原始返回）
        id: fetch
        run: |
          echo "正在获取网易财经市场数据..."
          data=$(curl -s "https://api.money.126.net/data/feed/0000001,1399001,money.api?callback=a")

          echo "------ 原始返回前300字符 ------"
          echo "$data" | head -c 300
          echo ""
          echo "--------------------------------"

          # 尝试提取数字字段（兼容多种写法）
          up=$(echo "$data" | grep -Eo '"up":[0-9]+' | head -1 | grep -Eo '[0-9]+')
          down=$(echo "$data" | grep -Eo '"down":[0-9]+' | head -1 | grep -Eo '[0-9]+')

          # 若为空，置为0防止报错
          up=${up:-0}
          down=${down:-0}

          echo "上涨家数: $up"
          echo "下跌家数: $down"

          echo "up=$up" >> $GITHUB_ENV
          echo "down=$down" >> $GITHUB_ENV

      - name: 判断并推送
        run: |
          up=${{ env.up }}
          down=${{ env.down }}

          title=""
          desp="当前上涨家数：${up}\n当前下跌家数：${down}\n\n📊 数据来源：网易财经"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            title="🧪 手动测试推送"
            echo "检测到手动运行，强制推送当前数据。"
          else
            if [ "$up" -gt 3000 ]; then
              title="📈 上涨家数超过3000家！"
            elif [ "$down" -gt 3000 ]; then
              title="📉 下跌家数超过3000家！"
            else
              echo "涨跌家数均未超过3000，无需推送。"
              exit 0
            fi
          fi

          echo "发送推送：$title"
          curl -G "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}.send" \
            --data-urlencode "title=$title" \
            --data-urlencode "desp=$desp"
