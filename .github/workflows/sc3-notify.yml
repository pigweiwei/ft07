name: æ£€æµ‹Aè‚¡æ¶¨è·Œå®¶æ•°å¹¶æ¨é€é€šçŸ¥

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 09:15â€“15:00 => UTC 01:15â€“07:00
    - cron: "*/15 1-7 * * 1-5"
  workflow_dispatch:

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: å®‰è£… jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: è·å–Aè‚¡æ¶¨è·Œå®¶æ•°
        id: fetch
        run: |
          url="https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&fields=f2,f3,f4,f12,f13,f14,f62,f66,f69,f72,f75,f78,f81,f84,f87,f124&secids=1.000001,0.399001,1.000300"
          response=$(curl -s "$url")

          if [ -z "$response" ]; then
            echo "error_msg=è¯·æ±‚å¤±è´¥" >> $GITHUB_ENV
            exit 0
          fi

          up_total=$(echo "$response" | jq '.data.diff[0].f66')
          down_total=$(echo "$response" | jq '.data.diff[0].f69')
          api_date=$(echo "$response" | jq -r '.data.diff[0].f124')

          if [ "$up_total" = "0" ] && [ "$down_total" = "0" ]; then
            echo "error_msg=æ•°æ®ä¸º0ï¼Œå¯èƒ½æ¥å£å¼‚å¸¸" >> $GITHUB_ENV
          fi

          echo "up_total=$up_total" >> $GITHUB_ENV
          echo "down_total=$down_total" >> $GITHUB_ENV
          echo "api_date=$api_date" >> $GITHUB_ENV

      - name: åˆ¤æ–­å¹¶æ¨é€
        run: |
          up_total=${{ env.up_total }}
          down_total=${{ env.down_total }}
          api_date=${{ env.api_date }}
          error_msg="${{ env.error_msg }}"

          mkdir -p data
          today=$(date +%Y-%m-%d)
          state_file="data/last_push.json"

          echo "æœ¬åœ°æ—¥æœŸï¼š$today"
          echo "API æ—¥æœŸï¼š$api_date"

          # å¦‚æœAPIæ—¥æœŸå’Œæœ¬åœ°æ—¥æœŸä¸ä¸€è‡´ï¼Œè¯´æ˜ä¼‘å¸‚ï¼Œä¸æ¨é€
          if [ "$api_date" != "$today" ]; then
            echo "æ£€æµ‹åˆ°APIæ—¥æœŸä¸æœ¬åœ°æ—¥æœŸä¸ç¬¦ï¼ˆå¯èƒ½ä¼‘å¸‚ï¼‰ï¼Œè·³è¿‡æ¨é€ã€‚"
            exit 0
          fi

          # åˆå§‹åŒ–æˆ–è¯»å–ä¸Šæ¬¡æ¨é€æ•°æ®
          if [ -f "$state_file" ]; then
            last_date=$(jq -r '.date' "$state_file")
            last_up=$(jq -r '.up' "$state_file")
            last_down=$(jq -r '.down' "$state_file")

            # å¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼Œåˆ™æ¸…ç©ºè®°å½•
            if [ "$last_date" != "$today" ]; then
              echo "{\"date\": \"$today\", \"up\": 0, \"down\": 0}" > "$state_file"
              last_up=0
              last_down=0
            fi
          else
            echo "{\"date\": \"$today\", \"up\": 0, \"down\": 0}" > "$state_file"
            last_up=0
            last_down=0
          fi

          up_diff=$((up_total - last_up))
          down_diff=$((down_total - last_down))
          up_diff_abs=${up_diff#-}
          down_diff_abs=${down_diff#-}

          echo "ä¸Šæ¬¡æ¨é€ï¼šä¸Šæ¶¨=${last_up} ä¸‹è·Œ=${last_down}"
          echo "æœ¬æ¬¡æ£€æµ‹ï¼šä¸Šæ¶¨=${up_total} ä¸‹è·Œ=${down_total}"
          echo "å˜åŒ–ï¼šä¸Šæ¶¨Î”=${up_diff} ä¸‹è·ŒÎ”=${down_diff}"

          # å¦‚æœä¸¤ä¸ªå˜åŒ–éƒ½ â‰¤ 500ï¼Œåˆ™é€€å‡º
          if [ "$up_diff_abs" -le 500 ] && [ "$down_diff_abs" -le 500 ]; then
            echo "å˜åŒ–ä¸è¶…è¿‡500ï¼Œæ— éœ€æ¨é€ã€‚"
            exit 0
          fi

          # å‘ä¸‹å–æ•´åˆ°100å€æ•°
          up_floor=$((up_total / 100 * 100))
          down_floor=$((down_total / 100 * 100))
          total=$((up_total + down_total))

          desp="ä¸Šæ¶¨å®¶æ•°ï¼š${up_total}  
          ä¸‹è·Œå®¶æ•°ï¼š${down_total}  
          æ€»ä½“å®¶æ•°ï¼š${total}"

          if [ -n "$error_msg" ]; then
            title="âš ï¸ Aè‚¡æ•°æ®å¼‚å¸¸ï¼"
            desp="$desp\n\nâš ï¸ é”™è¯¯ä¿¡æ¯ï¼š$error_msg"
          else
            if [ "$up_total" -gt 3000 ]; then
              title="ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°è¶…è¿‡${up_floor}å®¶ï¼"
            elif [ "$down_total" -gt 3000 ]; then
              title="ğŸ“‰ ä¸‹è·Œå®¶æ•°è¶…è¿‡${down_floor}å®¶ï¼"
            else
              echo "æ¶¨è·Œå®¶æ•°å‡æœªè¶…è¿‡3000ï¼Œæ— éœ€æ¨é€ã€‚"
              exit 0
            fi
          fi

          echo "å‘é€æ¨é€ï¼š$title"

          curl -G "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}.send" \
            --data-urlencode "title=$title" \
            --data-urlencode "desp=$desp"

          # æ›´æ–°æ¨é€è®°å½•
          echo "{\"date\": \"$today\", \"up\": $up_total, \"down\": $down_total}" > "$state_file"

      - name: ä¿å­˜æ¨é€çŠ¶æ€
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: last_push_data
          path: data/last_push.json
