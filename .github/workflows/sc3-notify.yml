name: 同花顺市场家数推送

on:
  schedule:
    - cron: "*/15 * * * *"  # 每15分钟执行一次
  workflow_dispatch:

jobs:
  ths_web_scrape:
    runs-on: ubuntu-latest
    env:
      SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}
    steps:
      - name: 安装 Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          pip install --upgrade pip
          pip install requests

      - name: 获取同花顺网页数据并推送
        run: |
          python - <<'EOF'
          import requests
          import os

          url = 'https://q.10jqka.com.cn/gn/'
          response = requests.get(url)
          data = response.json()

          up_count = data.get('RISECOUNT', 0)
          down_count = data.get('FALLCOUNT', 0)

          print(f"上涨家数: {up_count}")
          print(f"下跌家数: {down_count}")

          if up_count > 3000 or down_count > 3000:
              title = "市场家数预警"
              desp = f"上涨家数：{up_count}\n下跌家数：{down_count}"

              key = os.environ.get('SERVERCHAN_KEY', '')
              if key:
                  push_url = f"https://sc.ftqq.com/{key}.send"
                  requests.get(push_url, params={"text": title, "desp": desp})
                  print("推送完成")
              else:
                  print("SERVERCHAN_KEY 未设置")
          EOF
