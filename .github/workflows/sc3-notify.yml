name: æ£€æµ‹Aè‚¡æ¶¨è·Œå®¶æ•°å¹¶æ¨é€é€šçŸ¥

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 09:15â€“15:00 => UTC 01:15â€“07:00
    - cron: "*/15 1-7 * * 1-5"
  workflow_dispatch:

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: å®‰è£… jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: è®¾ç½®å½“å‰æ—¥æœŸï¼ˆå¤‡ç”¨ï¼‰
        run: echo "CURRENT_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      - name: è·å–æ¶¨è·Œå®¶æ•°
        id: fetch
        run: |
          # åˆå§‹åŒ–å˜é‡
          up_sh=""  # ä¸Šè¯ä¸Šæ¶¨
          down_sh=""  # ä¸Šè¯ä¸‹è·Œ
          up_sz=""  # æ·±è¯ä¸Šæ¶¨
          down_sz=""  # æ·±è¯ä¸‹è·Œ
          up_total=""  # åˆè®¡ä¸Šæ¶¨
          down_total=""  # åˆè®¡ä¸‹è·Œ
          data=""
          error_msg=""
          source="æœªçŸ¥"

          # ä¸»æ¥å£ï¼šä¸œæ–¹è´¢å¯Œï¼ˆä¸Šè¯+æ·±è¯ï¼‰
          echo "å°è¯•ä¸œæ–¹è´¢å¯Œæ¥å£..."
          data=$(curl -s -L -m 10 --compressed \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" \
            -H "Referer: https://www.eastmoney.com" \
            "https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=1.000001,0.399001,0.399006&fields=f62,f104,f105")
          status_code=$(curl -s -o /dev/null -w "%{http_code}" -L --compressed \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" \
            -H "Referer: https://www.eastmoney.com" \
            "https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=1.000001,0.399001,0.399006&fields=f62,f104,f105")
          echo "ä¸œæ–¹è´¢å¯Œæ¥å£çŠ¶æ€ç : $status_code"
          echo "ä¸œæ–¹è´¢å¯Œæ¥å£å“åº”é¢„è§ˆ: $(echo "$data" | head -c 1000)..."

          if [ "$status_code" -eq 200 ] && [ -n "$data" ] && echo "$data" | jq . >/dev/null 2>&1; then
            # æå–ä¸Šè¯ (1.000001) å’Œæ·±è¯æˆæŒ‡ (0.399001)
            up_sh=$(echo "$data" | jq -r '.data.diff[0].f104 // ""')
            down_sh=$(echo "$data" | jq -r '.data.diff[0].f105 // ""')
            up_sz=$(echo "$data" | jq -r '.data.diff[1].f104 // ""')
            down_sz=$(echo "$data" | jq -r '.data.diff[1].f105 // ""')
            if [ -n "$up_sh" ] && [ -n "$down_sh" ] && [ -n "$up_sz" ] && [ -n "$down_sz" ] && [ "$up_sh" != "0" ] && [ "$down_sh" != "0" ]; then
              source="ä¸œæ–¹è´¢å¯Œï¼ˆä¸Šè¯+æ·±è¯æˆæŒ‡ï¼‰"
              # è®¡ç®—åˆè®¡
              up_total=$((up_sh + up_sz))
              down_total=$((down_sh + down_sz))
            else
              error_msg="ä¸œæ–¹è´¢å¯Œæ•°æ®æ— æ•ˆ (ä¸Šè¯: up=$up_sh, down=$down_sh; æ·±è¯: up=$up_sz, down=$down_sz)"
            fi
          else
            error_msg="ä¸œæ–¹è´¢å¯Œæ¥å£å¤±è´¥ (çŠ¶æ€ç : $status_code, å“åº”é¢„è§ˆ: $(echo "$data" | head -c 100))."
          fi

          # å¦‚æœä¸œæ–¹è´¢å¯Œå¤±è´¥æˆ–æ•°æ®æ— æ•ˆï¼Œå°è¯•è…¾è®¯è´¢ç»
          if [ -z "$up_total" ] || [ -z "$down_total" ] || [ "$up_total" = "0" ] || [ "$down_total" = "0" ]; then
            echo "ä¸œæ–¹è´¢å¯Œå¤±è´¥æˆ–æ— æ•ˆï¼Œå°è¯•è…¾è®¯è´¢ç»æ¥å£..."
            data=$(curl -s -L -m 10 --compressed \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" \
              "https://qt.gtimg.cn/q=ff_zs000001,ff_zs000002")
            status_code=$(curl -s -o /dev/null -w "%{http_code}" -L --compressed \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" \
              "https://qt.gtimg.cn/q=ff_zs000001,ff_zs000002")
            echo "è…¾è®¯è´¢ç»æ¥å£çŠ¶æ€ç : $status_code"
            echo "è…¾è®¯è´¢ç»æ¥å£å“åº”é¢„è§ˆ: $(echo "$data" | head -c 1000)..."

            if [ "$status_code" -eq 200 ] && [ -n "$data" ]; then
              # æå–ä¸Šè¯ (zs000001) å’Œæ·±è¯ (zs000002)
              up_sh=$(echo "$data" | grep 'v_ff_zs000001="' | grep -o 'ä¸Šæ¶¨[0-9]*å®¶' | grep -o '[0-9]*' || echo "")
              down_sh=$(echo "$data" | grep 'v_ff_zs000001="' | grep -o 'ä¸‹è·Œ[0-9]*å®¶' | grep -o '[0-9]*' || echo "")
              up_sz=$(echo "$data" | grep 'v_ff_zs000002="' | grep -o 'ä¸Šæ¶¨[0-9]*å®¶' | grep -o '[0-9]*' || echo "")
              down_sz=$(echo "$data" | grep 'v_ff_zs000002="' | grep -o 'ä¸‹è·Œ[0-9]*å®¶' | grep -o '[0-9]*' || echo "")
              if [ -n "$up_sh" ] && [ -n "$down_sh" ] && [ -n "$up_sz" ] && [ -n "$down_sz" ]; then
                source="è…¾è®¯è´¢ç»ï¼ˆä¸Šè¯+æ·±è¯ï¼‰"
                up_total=$((up_sh + up_sz))
                down_total=$((down_sh + down_sz))
              else
                error_msg="$error_msg è…¾è®¯è´¢ç»æå–å¤±è´¥ (ä¸Šè¯: up=$up_sh, down=$down_sh; æ·±è¯: up=$up_sz, down=$down_sz)."
              fi
            else
              error_msg="$error_msg è…¾è®¯è´¢ç»æ¥å£å¤±è´¥ (çŠ¶æ€ç : $status_code)."
            fi
          fi

          # æ£€æŸ¥æœ€ç»ˆç»“æœ
          if [ -z "$up_total" ] || [ -z "$down_total" ] || [ "$up_total" = "0" ] || [ "$down_total" = "0" ]; then
            error_msg="æ•°æ®æå–å¤±è´¥æˆ–éäº¤æ˜“æ—¶é—´ï¼ˆå½“å‰: $(date)ï¼‰ã€‚$error_msg"
            echo "è­¦å‘Šï¼š$error_msg"
            echo "error_msg=$error_msg" >> $GITHUB_ENV
            up_sh=0
            down_sh=0
            up_sz=0
            down_sz=0
            up_total=0
            down_total=0
          else
            echo "æˆåŠŸè·å–ï¼ä¸Šè¯ä¸Šæ¶¨: $up_sh, ä¸‹è·Œ: $down_sh; æ·±è¯ä¸Šæ¶¨: $up_sz, ä¸‹è·Œ: $down_sz; åˆè®¡ä¸Šæ¶¨: $up_total, ä¸‹è·Œ: $down_total (æ¥æº: $source)"
          fi

          echo "up_sh=$up_sh" >> $GITHUB_ENV
          echo "down_sh=$down_sh" >> $GITHUB_ENV
          echo "up_sz=$up_sz" >> $GITHUB_ENV
          echo "down_sz=$down_sz" >> $GITHUB_ENV
          echo "up_total=$up_total" >> $GITHUB_ENV
          echo "down_total=$down_total" >> $GITHUB_ENV
          echo "source=$source" >> $GITHUB_ENV

      - name: åˆ¤æ–­å¹¶æ¨é€
        run: |
          up_total=${{ env.up_total }}
          down_total=${{ env.down_total }}
          error_msg="${{ env.error_msg }}"

          title=""
          desp="ä¸Šæ¶¨å®¶æ•°ï¼š${up_total}  
          ä¸‹è·Œå®¶æ•°ï¼š${down_total}"
          if [ -n "$error_msg" ]; then
            title="âš ï¸ Aè‚¡æ•°æ®å¼‚å¸¸ï¼ˆå‡ä¸º0ï¼‰ï¼"
            desp="$desp\n\nâš ï¸ é”™è¯¯ä¿¡æ¯ï¼š$error_msg"
          else
            if [ "$up_total" -gt 3000 ]; then
              title="ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°è¶…è¿‡3000å®¶ï¼"
            elif [ "$down_total" -gt 3000 ]; then
              title="ğŸ“‰ ä¸‹è·Œå®¶æ•°è¶…è¿‡3000å®¶ï¼"
            else
              echo "æ¶¨è·Œå®¶æ•°å‡æœªè¶…è¿‡3000ï¼Œæ— éœ€æ¨é€ã€‚"
              exit 0
            fi
          fi

          echo "å‘é€æ¨é€ï¼š$title"
          curl -G "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}.send" \
            --data-urlencode "title=$title" \
            --data-urlencode "desp=$desp"
