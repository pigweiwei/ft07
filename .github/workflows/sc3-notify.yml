name: åŒèŠ±é¡ºå¸‚åœºå®¶æ•°æ¨é€

on:
  schedule:
    - cron: "*/15 * * * *"  # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  ths_web_scrape:
    runs-on: ubuntu-latest
    env:
      SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}
    steps:
      - name: å®‰è£… Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: è·å–åŒèŠ±é¡ºç½‘é¡µæ•°æ®å¹¶æ¨é€
        run: |
          python - <<'EOF'
          import requests
          from bs4 import BeautifulSoup
          import os

          # åŒèŠ±é¡ºå¸‚åœºæ€»è§ˆé¡µé¢ URL
          url = "https://q.10jqka.com.cn/gn/"

          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
          }

          try:
              # è·å–ç½‘é¡µå†…å®¹
              response = requests.get(url, headers=headers)
              response.raise_for_status()

              # ä½¿ç”¨ BeautifulSoup è§£æç½‘é¡µ
              soup = BeautifulSoup(response.text, 'html.parser')

              # æŸ¥æ‰¾åŒ…å«ä¸Šæ¶¨å®¶æ•°å’Œä¸‹è·Œå®¶æ•°çš„å…ƒç´ 
              rise_count_element = soup.find('span', {'id': 'RISECOUNT'})
              fall_count_element = soup.find('span', {'id': 'FALLCOUNT'})

              # æå–ä¸Šæ¶¨å®¶æ•°å’Œä¸‹è·Œå®¶æ•°
              up_count = int(rise_count_element.text.strip()) if rise_count_element else 0
              down_count = int(fall_count_element.text.strip()) if fall_count_element else 0

              print(f"ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°: {up_count}")
              print(f"ğŸ“‰ ä¸‹è·Œå®¶æ•°: {down_count}")

              # åˆ¤æ–­æ˜¯å¦éœ€è¦æ¨é€
              event_name = os.environ.get('GITHUB_EVENT_NAME', '')
              force_push = event_name == 'workflow_dispatch'

              if force_push or up_count > 3000 or down_count > 3000:
                  title = "ğŸ§­ åŒèŠ±é¡ºå¸‚åœºå®¶æ•°ç›‘æ§"
                  if down_count > 3000:
                      title = "ğŸ“‰ ä¸‹è·Œå®¶æ•°è¿‡å¤š"
                  elif up_count > 3000:
                      title = "ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°è¿‡å¤š"
                  desp = f"ä¸Šæ¶¨å®¶æ•°ï¼š{up_count}\nä¸‹è·Œå®¶æ•°ï¼š{down_count}"

                  key = os.environ.get('SERVERCHAN_KEY', '')
                  if key:
                      push_url = f"https://sc.ftqq.com/{key}.send"
                      requests.get(push_url, params={"text": title, "desp": desp})
                      print("ğŸš€ æ¨é€å®Œæˆ")
                  else:
                      print("âš ï¸ SERVERCHAN_KEY æœªè®¾ç½®")
              else:
                  print("â¸ï¸ å½“å‰ä¸è§¦å‘æ¨é€")

          except Exception as e:
              print(f"âŒ æŠ“å–æˆ–æ¨é€å¤±è´¥: {e}")
          EOF
