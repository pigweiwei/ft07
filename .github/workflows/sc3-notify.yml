name: æ£€æµ‹Aè‚¡æ¶¨è·Œå®¶æ•°å¹¶æ¨é€é€šçŸ¥

on:
  schedule:
    # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼ˆGitHub Action ä½¿ç”¨ UTCï¼Œéœ€è¦æ¢ç®—ä¸ºåŒ—äº¬æ—¶é—´ -8 å°æ—¶ï¼‰
    # åŒ—äº¬æ—¶é—´ 09:15â€“15:00 => UTC 01:15â€“07:00
    - cron: "*/15 1-7 * * 1-5"
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  check_a_shares:
    runs-on: ubuntu-latest

    steps:
      - name: è·å–æ¶¨è·Œå®¶æ•°
        id: fetch
        run: |
          # ä½¿ç”¨ä¸œæ–¹è´¢å¯ŒAè‚¡å¸‚åœºæ•´ä½“è¡Œæƒ…API
          data=$(curl -s "https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&secids=1.000001,0.399001,0.399006&fields=f104,f105")
          
          # ä¸œæ–¹è´¢å¯Œæ¥å£ä¸­ f104 æ˜¯ä¸Šæ¶¨å®¶æ•°ï¼Œf105 æ˜¯ä¸‹è·Œå®¶æ•°
          up=$(echo $data | grep -o '"f104":[0-9]*' | grep -o '[0-9]*' | head -1)
          down=$(echo $data | grep -o '"f105":[0-9]*' | grep -o '[0-9]*' | head -1)

          echo "ä¸Šæ¶¨å®¶æ•°: $up"
          echo "ä¸‹è·Œå®¶æ•°: $down"

          # è¾“å‡ºå˜é‡ç»™ä¸‹ä¸€ä¸ªæ­¥éª¤
          echo "up=$up" >> $GITHUB_ENV
          echo "down=$down" >> $GITHUB_ENV

      - name: åˆ¤æ–­å¹¶æ¨é€
        if: env.up != '' && env.down != ''
        run: |
          up=${{ env.up }}
          down=${{ env.down }}
          
          title=""
          desp="å½“å‰ä¸Šæ¶¨å®¶æ•°ï¼š${up}\nå½“å‰ä¸‹è·Œå®¶æ•°ï¼š${down}\n\nğŸ“Š æ•°æ®æ¥æºï¼šä¸œæ–¹è´¢å¯Œç½‘"

          if [ "$up" -gt 3000 ]; then
            title="ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°è¶…è¿‡3000å®¶ï¼"
          elif [ "$down" -gt 3000 ]; then
            title="ğŸ“‰ ä¸‹è·Œå®¶æ•°è¶…è¿‡3000å®¶ï¼"
          else
            echo "æ¶¨è·Œå®¶æ•°å‡æœªè¶…è¿‡3000ï¼Œæ— éœ€æ¨é€ã€‚"
            exit 0
          fi
          
          curl -G "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}.send" \
            --data-urlencode "title=$title" \
            --data-urlencode "desp=$desp"
