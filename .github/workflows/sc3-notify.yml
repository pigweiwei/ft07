name: Aè‚¡ä¸Šæ¶¨æé†’ - Serveré…± SC3

on:
  schedule:
    - cron: '0 7 * * 1-5'  # æ¯å¤© UTC 7:00 (åŒ—äº¬ 15:00ï¼Œæ”¶ç›˜åæ£€æŸ¥ï¼›å‘¨ä¸€åˆ°å‘¨äº”)
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  check-stock:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£… Python ä¾èµ–
        run: |
          sudo apt update
          sudo apt install python3-pip
          pip3 install requests pandas

      - name: è¿è¡Œ Aè‚¡ä¸Šæ¶¨æ£€æŸ¥è„šæœ¬
        env:
          SC3_KEY: ${{ secrets.SC3_KEY }}
        run: python3 -c "
import requests
import pandas as pd
import json
from datetime import datetime

# Ashare æ ¸å¿ƒå‡½æ•°ï¼šè·å–æ¶¨è·Œå®¶æ•° (ä»æ–°æµªæŠ“å–)
def get_up_down_count():
    url = 'http://qh1.sse.comnc.cn/uc/service?callback=abc&action=market.uc.getMarketData&marketId=0'
    resp = requests.get(url).text
    data = resp[3:-1]  # ç§»é™¤ callback
    df = pd.read_json(data)
    up_count = len(df[df['changeRate'] > 0])  # ä¸Šæ¶¨å®¶æ•°
    down_count = len(df[df['changeRate'] < 0])  # ä¸‹è·Œå®¶æ•°
    flat_count = len(df[df['changeRate'] == 0])  # å¹³ç›˜å®¶æ•°
    return up_count, down_count, flat_count, df

# è·å–æ¶¨å¹…å‰5è‚¡ç¥¨
def get_top_gainers(df, top_n=5):
    gainers = df.nlargest(top_n, 'changeRate')[['name', 'changeRate', 'price']]
    return gainers.to_markdown(index=False)

up, down, flat, df = get_up_down_count()

if up > 1000:
    top5 = get_top_gainers(df)
    title = f'ğŸš€ Aè‚¡å¤§æ¶¨è­¦æŠ¥ï¼ä¸Šæ¶¨ {up} å®¶'
    content = f'''
**å¸‚åœºå¿«æŠ¥** (ä»Šæ—¥ {datetime.now().strftime('%Y-%m-%d')}):
- ä¸Šæ¶¨: {up} å®¶
- ä¸‹è·Œ: {down} å®¶
- å¹³ç›˜: {flat} å®¶

**æ¶¨å¹…å‰ 5 å**:
{top5}

[æŸ¥çœ‹è¯¦æƒ…](http://quote.eastmoney.com/center/gridlist.html#hs_a_board)
'''
    
    # å‘é€ SC3 é€šçŸ¥
    api_url = f'https://sc3.ft07.com/{SC3_KEY}.send'
    data = {'text': title, 'desp': content}
    resp = requests.post(api_url, data=data)
    if resp.status_code == 200:
        print('âœ… é€šçŸ¥å‘é€æˆåŠŸï¼')
    else:
        print(f'âŒ å‘é€å¤±è´¥: {resp.text}')
else:
    print(f'ğŸ“Š ä¸Šæ¶¨å®¶æ•° {up} â‰¤ 1000ï¼Œæ— éœ€æé†’')
"
