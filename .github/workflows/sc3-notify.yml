name: åŒèŠ±é¡ºç½‘é¡µå®¶æ•°æ¨é€

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  ths_web_scrape:
    runs-on: ubuntu-latest
    steps:
      - name: è·å–åŒèŠ±é¡ºç½‘é¡µæ•°æ®
        run: |
          echo "ğŸŒ æ­£åœ¨æŠ“å–åŒèŠ±é¡ºå¸‚åœºæ€»è§ˆç½‘é¡µ..."

          # è®¾ç½®User-Agenté˜²æ­¢è¢«æ‹’
          html=$(curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" "https://q.10jqka.com.cn/")

          # æ‰“å°ç½‘é¡µå‰500å­—ç¬¦æ£€æŸ¥
          echo "${html:0:500}"

          # æå–ä¸Šæ¶¨ã€ä¸‹è·Œå®¶æ•° (å‡è®¾ç½‘é¡µé‡Œæœ‰ç±»ä¼¼ 'ä¸Šæ¶¨å®¶æ•° 1234' çš„æ–‡æœ¬)
          up_count=$(echo "$html" | grep -oP 'ä¸Šæ¶¨å®¶æ•°\s*\K[0-9]+')
          down_count=$(echo "$html" | grep -oP 'ä¸‹è·Œå®¶æ•°\s*\K[0-9]+')

          up_count=${up_count:-0}
          down_count=${down_count:-0}

          echo "ğŸ“ˆ ä¸Šæ¶¨å®¶æ•°: $up_count"
          echo "ğŸ“‰ ä¸‹è·Œå®¶æ•°: $down_count"

          # æ¨é€é€»è¾‘ï¼ˆæ‰‹åŠ¨æˆ–æ¡ä»¶è§¦å‘ï¼‰
          force_push=false
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            force_push=true
          fi

          if $force_push || [ "$up_count" -gt 3000 ] || [ "$down_count" -gt 3000 ]; then
            title="ğŸ“Š åŒèŠ±é¡ºå¸‚åœºå®¶æ•°ç›‘æ§"
            desp="ä¸Šæ¶¨å®¶æ•°ï¼š$up_count\nä¸‹è·Œå®¶æ•°ï¼š$down_count"

            echo "ğŸš€ æ¨é€ Serveré…±..."
            curl -s "https://12404.push.ft07.com/send/${{ secrets.SERVERCHAN_KEY }}.send" \
              --data-urlencode "title=$title" \
              --data-urlencode "desp=$desp"
          else
            echo "â¸ï¸ å½“å‰ä¸è§¦å‘æ¨é€"
          fi
